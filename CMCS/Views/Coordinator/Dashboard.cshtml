@using CMCS.Models
@{
    ViewData["Title"] = "Coordinator Dashboard";
    var claims = ViewBag.Claims as List<Claim>;
}

<div style="font-family:'Segoe UI'; padding:40px; background-color:#F5F5F5; min-height:100vh;">
    <h2 style="color:#1F3B6B; margin-bottom:25px; font-size:28px;">Programme Coordinator Dashboard</h2>

    <div style="margin-bottom:20px; max-width:400px;">
        <input type="text" id="searchInput" placeholder="Search by Month, Submitted By, or Verification..."
               style="width:100%; padding:10px 15px; border-radius:8px; border:1px solid #ccc; font-size:14px;
                      outline:none; box-shadow:0 2px 4px rgba(0,0,0,0.05); transition: all 0.3s;">
    </div>

    <div style="overflow-x:auto; background:white; border-radius:8px; padding:10px;">
        <table id="claimsTable" style="width:100%; border-collapse:collapse;">
            <thead>
                <tr style="background-color:#2A5298; color:white; text-align:left;">
                    <th style="padding:14px;">Month</th>
                    <th style="padding:14px;">Submitted By</th>
                    <th style="padding:14px;">Hours</th>
                    <th style="padding:14px;">Rate</th>
                    <th style="padding:14px;">Verification Status</th>
                    <th style="padding:14px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var claim in claims)
                {
                    <tr style="border-bottom:1px solid #ddd;">
                        <td style="padding:12px;">@claim.Month</td>

                        <td style="padding:12px;">
                            @(claim.User != null ? $"{claim.User.FirstName} {claim.User.LastName}" : "-")
                        </td>
                        <td style="padding:12px;">@claim.HoursWorked</td>
                        <td style="padding:12px;">R @String.Format("{0:N2}", claim.HourlyRate)</td>
                        <td style="padding:10px; color:white; font-weight:bold; text-align:center;
                                                background-color:@(
                            claim.VerificationStatus == ClaimVerificationStatus.Pending ? "#D67F2B" :
                            claim.VerificationStatus == ClaimVerificationStatus.Verified ? "#4CAF50" :
                            claim.VerificationStatus == ClaimVerificationStatus.Rejected ? "#C0392B" : "#D67F2B"
                                                                                                ); ">
                        @claim.VerificationStatus
                    </td>
                    <td style="padding:12px;">
                        <a href="/Coordinator/ClaimDetails?claimId=@claim.ClaimID"
                           style="padding:8px 14px; background-color:#2A5298; color:white; text-decoration:none; border-radius:6px; margin-right:6px;">
                            Details
                        </a>

                        @if (claim.VerificationStatus == ClaimVerificationStatus.Pending)
                            {
                                <button type="button"
                                        onclick="openConfirmPopup(@claim.ClaimID, 'verify')"
                                        style="padding:8px 14px; background-color:#4CAF50; color:white; border:none; border-radius:6px; cursor:pointer; margin-right:6px;">
                                    Verify
                                </button>

                                <button type="button"
                                        onclick="openConfirmPopup(@claim.ClaimID, 'reject')"
                                        style="padding:8px 14px; background-color:#C0392B; color:white; border:none; border-radius:6px; cursor:pointer;">
                                    Reject
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div id="namePopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.4); justify-content:center; align-items:center;">
    <div style="background:white; padding:25px; border-radius:10px; width:320px; text-align:center; box-shadow:0 0 10px rgba(0,0,0,0.2);">
        <h3 id="popupTitle" style="color:#1F3B6B; margin-bottom:15px;">Confirm Action</h3>
        <p id="popupMessage" style="margin-bottom:15px;">Are you sure you want to proceed?</p>
        <div>
            <button onclick="submitAction()" style="background-color:#2A5298; color:white; border:none; padding:8px 14px; border-radius:6px; margin-right:8px;">Confirm</button>
            <button onclick="closeNamePopup()" style="background-color:#C0392B; color:white; border:none; padding:8px 14px; border-radius:6px;">Cancel</button>
        </div>
    </div>
</div>

<form id="verifyForm" method="post" asp-action="VerifyOrRejectClaim" asp-controller="Coordinator" style="display:none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="claimId" id="hiddenClaimId" />
    <input type="hidden" name="actionType" id="hiddenActionType" />
</form>

<script>
    let currentClaimId = null;
    let currentAction = null;

    function openConfirmPopup(claimId, action) {
        currentClaimId = claimId;
        currentAction = action;
        document.getElementById('popupTitle').textContent =
            action === 'reject' ? 'Reject Claim' : 'Verify Claim';
        document.getElementById('popupMessage').textContent =
            action === 'reject' ? 'Are you sure you want to reject this claim?' : 'Are you sure you want to verify this claim?';
        document.getElementById('namePopup').style.display = 'flex';
    }

    function closeNamePopup() {
        document.getElementById('namePopup').style.display = 'none';
    }

    function submitAction() {
        document.getElementById('hiddenClaimId').value = currentClaimId;
        document.getElementById('hiddenActionType').value = currentAction;
        document.getElementById('verifyForm').submit();
    }

    const searchInput = document.getElementById("searchInput");
    const claimsTable = document.getElementById("claimsTable");
    const rows = claimsTable.querySelectorAll("tbody tr");

    searchInput.addEventListener("input", function () {
        const filter = searchInput.value.toLowerCase();

        rows.forEach(row => {
            const month = row.cells[0].textContent.toLowerCase();
            const submittedBy = row.cells[1].textContent.toLowerCase();
            const verification = row.cells[4].textContent.toLowerCase();

            row.style.display = (month.includes(filter) || submittedBy.includes(filter) || verification.includes(filter)) ? "" : "none";
        });
    });
</script>
